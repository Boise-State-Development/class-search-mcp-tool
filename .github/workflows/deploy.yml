name: Build and Deploy MCP Lambda

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag'
        required: false
        default: 'latest'

env:
  # CDK Configuration - from GitHub Variables
  CDK_PROJECT_PREFIX: ${{ vars.CDK_PROJECT_PREFIX || 'mcp-docker-lambda' }}
  CDK_AWS_REGION: ${{ vars.CDK_AWS_REGION || 'us-west-2' }}
  CDK_AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  CDK_LAMBDA_MEMORY_MB: ${{ vars.CDK_LAMBDA_MEMORY_MB || '512' }}
  CDK_LAMBDA_TIMEOUT_SECONDS: ${{ vars.CDK_LAMBDA_TIMEOUT_SECONDS || '30' }}

  # AWS Credentials
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ${{ vars.CDK_AWS_REGION || 'us-west-2' }}

permissions:
  id-token: write
  contents: read

jobs:
  # ============================================================================
  # Build Docker Image
  # ============================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="${{ github.sha }}"
          fi
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "CDK_IMAGE_TAG=${TAG}" >> $GITHUB_ENV

      - name: Build Docker image
        env:
          CDK_IMAGE_TAG: ${{ steps.set-tag.outputs.image_tag }}
          EXPORT_TAR: "true"
        run: ./scripts/stack-mcp-lambda/build-docker.sh

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: "*.tar"
          retention-days: 1

  # ============================================================================
  # Synthesize CDK Templates
  # ============================================================================
  synth-cdk:
    name: Synthesize CDK
    runs-on: ubuntu-latest
    needs: [build-docker]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install CDK dependencies
        run: ./scripts/stack-mcp-lambda/install.sh

      - name: Synthesize CDK stack
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
        run: ./scripts/stack-mcp-lambda/synth.sh

      - name: Upload CDK output artifact
        uses: actions/upload-artifact@v4
        with:
          name: cdk-out
          path: infrastructure/cdk.out
          retention-days: 1

  # ============================================================================
  # CDK Diff (PRs only)
  # ============================================================================
  diff-cdk:
    name: CDK Diff
    runs-on: ubuntu-latest
    needs: [build-docker, synth-cdk]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install CDK dependencies
        run: ./scripts/stack-mcp-lambda/install.sh

      - name: Download CDK output artifact
        uses: actions/download-artifact@v4
        with:
          name: cdk-out
          path: infrastructure/cdk.out

      - name: Show CDK diff
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
        run: ./scripts/stack-mcp-lambda/diff.sh

  # ============================================================================
  # Push Docker Image to ECR
  # ============================================================================
  push-docker:
    name: Push to ECR
    runs-on: ubuntu-latest
    needs: [build-docker, synth-cdk]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    outputs:
      ecr_image_uri: ${{ steps.push.outputs.ecr_image_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Push Docker image to ECR
        id: push
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
          LOAD_TAR: "${{ env.CDK_PROJECT_PREFIX }}-mcp-tool-${{ needs.build-docker.outputs.image_tag }}.tar"
        run: ./scripts/stack-mcp-lambda/push-docker.sh

  # ============================================================================
  # Deploy to AWS
  # ============================================================================
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build-docker, synth-cdk, push-docker]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install CDK dependencies
        run: ./scripts/stack-mcp-lambda/install.sh

      - name: Download CDK output artifact
        uses: actions/download-artifact@v4
        with:
          name: cdk-out
          path: infrastructure/cdk.out

      - name: Deploy CDK stack
        id: deploy
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
        run: ./scripts/stack-mcp-lambda/deploy.sh

      - name: Output deployment info
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.build-docker.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Image:** ${{ needs.push-docker.outputs.ecr_image_uri }}" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ steps.deploy.outputs.function_url }}" ]]; then
            echo "**Function URL:** ${{ steps.deploy.outputs.function_url }}" >> $GITHUB_STEP_SUMMARY
          fi
